# WARRANTY_DAYS

Сервис на Go для получения информации по VIN.

## Что делает проект

- Отдает список обращений по VIN (регистронезависимый поиск).
- Считает дни ремонта в пределах текущего гарантийного года для VIN.
- Поднимает HTTP API и работает с PostgreSQL через GORM.

## Технологический стек

- Go `1.25`
- HTTP: стандартный `net/http`
- База данных: PostgreSQL
- ORM: `gorm` + `gorm.io/driver/postgres`
- Конфиг: переменные окружения (`.env`), загрузка через `godotenv`
- Линтинг/форматирование: `golangci-lint` v2, `gofmt`, `goimports`

## Структура проекта

- `cmd/api/main.go` — точка входа, инициализация конфига, БД и HTTP роутера.
- `internal/config` — загрузка и валидация конфигурации из env.
- `internal/db` — подключение к PostgreSQL и настройки пула соединений.
- `internal/models` — модели домена (`Claim`).
- `internal/repo` — слой доступа к данным и бизнес-логика расчета дней ремонта.
- `internal/httpapi/handler` — HTTP-обработчики.
- `internal/httpapi/router` — маршрутизация и ограничение HTTP-методов.
- `migrations` — SQL-миграции (создание таблицы `claims` и индексов).
- `.golangci.yml` — конфигурация линтеров и форматтеров.

## Конфигурация

Используются переменные окружения:

- `APP_ENV`
- `HTTP_ADDR` (по умолчанию `:8080`)
- `DB_HOST` (по умолчанию `127.0.0.1`)
- `DB_PORT` (по умолчанию `5432`)
- `DB_USER` (обязательный)
- `DB_PASSWORD` (обязательный)
- `DB_NAME` (обязательный)
- `DB_SSLMODE` (по умолчанию `disable`)

Пример есть в файле `.env`.

## Запуск

1. Поднять PostgreSQL и создать БД (например, `warranty_days`).
2. Применить миграцию `migrations/001_create_claims.sql`.
3. Заполнить переменные окружения (или `.env`).
4. Запустить сервис:

```bash
go run ./cmd/api
```

Сервис стартует на адресе из `HTTP_ADDR` (по умолчанию `:8080`).

## API и задачи

### 1) Проверка доступности

- `GET /health`
- Ответ: `ok`

### 2) Получить все обращения по VIN

- `GET /claims?vin=XXX`
- Поиск VIN регистронезависимый (`LOWER(vin) = LOWER(?)`).
- Ответ: JSON-массив записей `Claim`.

### 3) Рассчитать дни ремонта в текущем гарантийном году

- `GET /claims/warranty-year?vin=XXX`
- Логика:
  - Берется самая ранняя `retail_date` по VIN.
  - Рассчитывается окно текущего гарантийного года относительно текущей даты.
  - Выбираются обращения, пересекающие это окно.
  - Для каждого обращения считается пересечение по датам (включительно).
- Ответ:

```json
{
  "items": [
    {
      "claim": { "id": 1, "vin": "XXX", "retail_date": "2024-01-10T00:00:00Z" },
      "repair_days": 3
    }
  ],
  "total_days": 3
}
```

## Линтинг

Проверка кода:

```bash
golangci-lint run ./...
```
